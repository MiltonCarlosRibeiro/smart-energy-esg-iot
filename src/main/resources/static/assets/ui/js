window.UI = (function () {
  const state = {
    room: "Sala 101",
    presence: false,
    lightOn: false,
    temperature: 24.0
  };

  let chart;
  function initChart() {
    const ctx = document.getElementById("chartTemp");
    chart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{ label: "Temperatura (°C)", data: [] }] },
      options: { animation:false, scales:{ y:{ beginAtZero:false } } }
    });
  }

  function updateStatusView(reading) {
    if (!reading) return;
    document.getElementById("room").textContent = reading.room;
    document.getElementById("presence").textContent = reading.presence ? "Sim" : "Não";
    document.getElementById("light").textContent = reading.lightOn ? "Ligada" : "Desligada";
    document.getElementById("temp").textContent = reading.temperature?.toFixed?.(1) ?? "-";
    document.getElementById("ts").textContent = new Date(reading.ts).toLocaleString();

    // gráfico
    if (chart) {
      const t = new Date(reading.ts).toLocaleTimeString();
      chart.data.labels.push(t);
      chart.data.datasets[0].data.push(reading.temperature ?? null);
      if (chart.data.labels.length > 30) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    // sincroniza com estado local
    state.room = reading.room;
    state.presence = !!reading.presence;
    state.lightOn = !!reading.lightOn;
    state.temperature = reading.temperature ?? state.temperature;
  }

  function bindButtons() {
    document.getElementById("btnPresence").onclick = () => { state.presence = !state.presence; };
    document.getElementById("btnLight").onclick = () => { state.lightOn = !state.lightOn; };
    document.getElementById("btnSend").onclick = () => {
      window.IOT.sendTelemetry({ ...state });
    };
  }

  function latestLoop() {
    window.IOT.fetchLatest(state.room).then(updateStatusView).catch(()=>{});
  }

  function init() {
    initChart();
    bindButtons();
    latestLoop();
    setInterval(latestLoop, 3000);
  }

  return { init, updateStatusView, state };
})();
document.addEventListener("DOMContentLoaded", UI.init);
